name: GHA Caching Test
run-name: ${{ github.actor }} is building and testing some GHA Caching üêøÔ∏è ${{ github.event.head_commit.message }}

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, closed ]
    paths-ignore:
      - "README.md"

env:
  FOO: bar

jobs:
  StashFiles:
    name: Cache some files üå∞
    runs-on: ubuntu-latest
    steps:
      - name: Install tree
        run: sudo apt-get install tree
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Create some files in a directory
        run: |
          mkdir -p ./test
          echo foo > ./test/test1.txt
          echo bar > ./test/test2.txt
          echo baz > ./test/test3.txt

      - name: Cache some files
        uses: actions/cache@v2
        with:
          path: ./test
          key: ${{ runner.os }}-test-files

  StashMoreFiles:
    name: Cache some files üå∞
    runs-on: ubuntu-latest
    steps:
      - name: Install tree
        run: sudo apt-get install tree
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Create some files in a directory
        run: |
          mkdir -p ./test
          echo foobar > ./test/test3.txt
          echo barbaz > ./test/test4.txt
          echo bazfoo > ./test/test5.txt

      - name: Cache some files
        uses: actions/cache@v2
        with:
          path: ./test
          key: ${{ runner.os }}-test-files-2

  RestoreFiles:
    name: Restore some files üêøÔ∏è
    runs-on: ubuntu-latest
    needs: [ StashFiles, StashMoreFiles ]
    steps:
      - name: Install tree
        run: sudo apt-get install tree
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Check for cached files (they shouldn't be there)
        run: tree
      - name: Restore cached files
        uses: actions/cache@v2
        with:
          path: ./test/*
          key: ${{ runner.os }}-test-files
      - name: Restore other cached files
        with:
          path: ./test/*
          key: ${{ runner.os }}-test-files2
      - name: Show files
        run: tree
